{"version":3,"file":"context.development.js","sources":["../../src/context.ts"],"sourcesContent":["import type { CB, Maybe } from 'vest-utils';\nimport {\n  assign,\n  defaultTo,\n  invariant,\n  optionalFunctionValue,\n  Nullable,\n} from 'vest-utils';\n\nconst USEX_DEFAULT_ERROR_MESSAGE = 'Not inside of a running context.';\nconst EMPTY_CONTEXT = Symbol();\n\n/**\n * Base context interface.\n */\nexport function createContext<T>(defaultContextValue?: T): CtxApi<T> {\n  let contextValue: T | symbol = EMPTY_CONTEXT;\n\n  return {\n    run,\n    use,\n    useX,\n  };\n\n  function use(): T {\n    return (isInsideContext() ? contextValue : defaultContextValue) as T;\n  }\n\n  function useX(errorMessage?: string): T {\n    invariant(\n      isInsideContext(),\n      defaultTo(errorMessage, USEX_DEFAULT_ERROR_MESSAGE)\n    );\n    return contextValue as T;\n  }\n\n  function run<R>(value: T, cb: () => R): R {\n    const parentContext = isInsideContext() ? use() : EMPTY_CONTEXT;\n\n    contextValue = value;\n\n    const res = cb();\n\n    contextValue = parentContext;\n    return res;\n  }\n\n  function isInsideContext(): boolean {\n    return contextValue !== EMPTY_CONTEXT;\n  }\n}\n\n/**\n * Cascading context - another implementation of context, that assumes the context value is an object.\n * When nesting context runs, the the values of the current layer merges with the layers above it.\n */\nexport function createCascade<T extends Record<string, unknown>>(\n  init?: (value: Partial<T>, parentContext: Maybe<T>) => Nullable<T>\n): CtxCascadeApi<T> {\n  const ctx = createContext<T>();\n\n  return {\n    bind,\n    run,\n    use: ctx.use,\n    useX: ctx.useX,\n  };\n\n  function run<R>(value: Partial<T>, fn: () => R): R {\n    const parentContext = ctx.use();\n\n    const out = assign(\n      {},\n      parentContext ? parentContext : {},\n      optionalFunctionValue(init, value, parentContext) ?? value\n    ) as T;\n\n    return ctx.run(Object.freeze(out), fn) as R;\n  }\n\n  function bind<Fn extends CB>(value: Partial<T>, fn: Fn) {\n    return function (...runTimeArgs: Parameters<Fn>) {\n      return run<ReturnType<Fn>>(value, function () {\n        return fn(...runTimeArgs);\n      });\n    } as Fn;\n  }\n}\n\ntype ContextConsumptionApi<T> = {\n  use: () => T;\n  useX: (errorMessage?: string) => T;\n};\n\nexport type CtxApi<T> = ContextConsumptionApi<T> & {\n  run: <R>(value: T, cb: () => R) => R;\n};\n\nexport type CtxCascadeApi<T> = ContextConsumptionApi<T> & {\n  run: <R>(value: Partial<T>, fn: () => R) => R;\n  bind: <Fn extends CB>(value: Partial<T>, fn: Fn) => Fn;\n};\n"],"names":["invariant","defaultTo","assign","optionalFunctionValue"],"mappings":";;;;;;EASA,MAAM,0BAA0B,GAAG,kCAAkC,CAAC;EACtE,MAAM,aAAa,GAAG,MAAM,EAAE,CAAC;EAE/B;;EAEG;EACG,SAAU,aAAa,CAAI,mBAAuB,EAAA;MACtD,IAAI,YAAY,GAAe,aAAa,CAAC;MAE7C,OAAO;UACL,GAAG;UACH,GAAG;UACH,IAAI;OACL,CAAC;EAEF,IAAA,SAAS,GAAG,GAAA;EACV,QAAA,QAAQ,eAAe,EAAE,GAAG,YAAY,GAAG,mBAAmB,EAAO;OACtE;MAED,SAAS,IAAI,CAAC,YAAqB,EAAA;UACjCA,mBAAS,CACP,eAAe,EAAE,EACjBC,mBAAS,CAAC,YAAY,EAAE,0BAA0B,CAAC,CACpD,CAAC;EACF,QAAA,OAAO,YAAiB,CAAC;OAC1B;EAED,IAAA,SAAS,GAAG,CAAI,KAAQ,EAAE,EAAW,EAAA;EACnC,QAAA,MAAM,aAAa,GAAG,eAAe,EAAE,GAAG,GAAG,EAAE,GAAG,aAAa,CAAC;UAEhE,YAAY,GAAG,KAAK,CAAC;EAErB,QAAA,MAAM,GAAG,GAAG,EAAE,EAAE,CAAC;UAEjB,YAAY,GAAG,aAAa,CAAC;EAC7B,QAAA,OAAO,GAAG,CAAC;OACZ;EAED,IAAA,SAAS,eAAe,GAAA;UACtB,OAAO,YAAY,KAAK,aAAa,CAAC;OACvC;EACH,CAAC;EAED;;;EAGG;EACG,SAAU,aAAa,CAC3B,IAAkE,EAAA;EAElE,IAAA,MAAM,GAAG,GAAG,aAAa,EAAK,CAAC;MAE/B,OAAO;UACL,IAAI;UACJ,GAAG;UACH,GAAG,EAAE,GAAG,CAAC,GAAG;UACZ,IAAI,EAAE,GAAG,CAAC,IAAI;OACf,CAAC;EAEF,IAAA,SAAS,GAAG,CAAI,KAAiB,EAAE,EAAW,EAAA;;EAC5C,QAAA,MAAM,aAAa,GAAG,GAAG,CAAC,GAAG,EAAE,CAAC;EAEhC,QAAA,MAAM,GAAG,GAAGC,gBAAM,CAChB,EAAE,EACF,aAAa,GAAG,aAAa,GAAG,EAAE,EAClC,CAAA,EAAA,GAAAC,+BAAqB,CAAC,IAAI,EAAE,KAAK,EAAE,aAAa,CAAC,MAAA,IAAA,IAAA,EAAA,KAAA,KAAA,CAAA,GAAA,EAAA,GAAI,KAAK,CACtD,CAAC;EAEP,QAAA,OAAO,GAAG,CAAC,GAAG,CAAC,MAAM,CAAC,MAAM,CAAC,GAAG,CAAC,EAAE,EAAE,CAAM,CAAC;OAC7C;EAED,IAAA,SAAS,IAAI,CAAgB,KAAiB,EAAE,EAAM,EAAA;UACpD,OAAO,UAAU,GAAG,WAA2B,EAAA;cAC7C,OAAO,GAAG,CAAiB,KAAK,EAAE,YAAA;EAChC,gBAAA,OAAO,EAAE,CAAC,GAAG,WAAW,CAAC,CAAC;EAC5B,aAAC,CAAC,CAAC;EACL,SAAO,CAAC;OACT;EACH;;;;;;;;;"}